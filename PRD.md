# 📝 需求文档：肝脏代谢模拟工具

## 1\. 简介 (Introduction)

### 1.1 背景与目标

本项目旨在开发一个高度自动化、基于大型语言模型（LLM）的肝脏代谢模拟工具。该工具的核心目标是利用 LLM 的知识库和推理能力，自动生成、细化、格式化肝脏代谢的输入/输出数据、条件和参数，并自动构建、运行、调优模拟代码，以实现对真实肝脏代谢流的精确模拟。

### 1.2 范围与交付物

**范围：** 涉及肝脏主要功能模块的代谢路径、速率参数生成、代码结构自动构建、结果校验与参数自调优。

**交付物：**

1.  格式化的肝功能模块元数据文件（JSON）。
2.  基于 Python 的模拟代码。
3.  详细的参数配置文件（JSON/YAML）。
4.  模拟结果可视化报告。

## 2\. 功能模块需求 (Functional Requirements)

### 2.1 阶段 I：知识提取与结构化（LLM 数据生成器）

**R1.1 自动生成模块层次结构**

  * **需求：** LLM 必须能够从高粒度（如：碳水代谢）自动向下细化到中粒度（如：糖异生、糖原合成），并生成每个细化粒度（模块函数）的完整输入和输出描述、以及控制条件。模块上下层之间仅存在包含关系，不存在依赖关系。
  * **输入：** 肝脏主要功能模块名称列表（例如：碳水代谢、脂代谢、解毒模块等）。
  * **输出：** 多层级的代谢模块清单，包含每个模块的：
      * 模块名称/功能。
      * 上层/下层模块包含关系。
      * 完整的代谢物输入列表。
      * 完整的代谢物输出列表。
      * 模块反应发生的详细控制条件。

**R1.2 代谢物名称自动纠正与统一**

  * **需求：** LLM 必须能识别并统一不同代谢模块中对同一物质的不同称呼（例如：葡萄糖 $\leftrightarrow$ 血浆葡萄糖；三酰甘油 $\leftrightarrow$ 甘油三酯）。
  * **机制：** 自动构建一个统一的代谢物词汇表。
  * **输出：** 所有模块输入输出中的代谢物名称必须符合统一的词汇表。

**R1.3 格式化元数据文件生成**

  * **需求：** 自动将 R1.1 和 R1.2 生成的结构化数据转化为符合特定要求的JSON 或 YAML格式文件，作为后续代码构建的输入。
  * **格式要求（示例 JSON 结构）：**

<!-- end list -->

```json
{
  "top_modules": [
    {
      "module_name": "糖异生",
      "inputs": ["乳酸", "丙酮酸", "生糖氨基酸", "ATP"],
      "outputs": ["葡萄糖", "ADP"],
      "control_conditions": "胰岛素/胰高糖素比率调节控制酶活性",
    },
    // ... 其他模块
  ]
}
```

**R1.4 初始代谢速率参数生成**

  * **需求：** LLM 需根据其知识，为每个细化模块（如：糖异生速率、白蛋白合成速率）生成合理的初始影响代谢速率的参数列表及其初始值。
  * **参数类型：**
      * **环境参数：** 如 $\text{pH}$、温度。
      * **酶活性参数：** 如 $K_m$、$V_{max}$ 或等效的速率常数。
      * **激素调节因子：** 如胰岛素/胰高血糖素浓度。

### 2.2 阶段 II：模型构建与模拟运行（LLM 代码生成器）

**R2.1 自动构建生产者-消费者模型代码**

  * **需求：** LLM 必须基于 R1.3 生成的 JSON 元数据，自动构建模拟肝脏代谢流的代码。
  * **模型映射：**
      * 每个细化模块（如“糖异生”）映射为一个函数；代谢物映射为共享资源池或队列，存于单独的环境模块中。
      * 代码结构应包含并发/异步处理（例如，使用线程或进程模拟并行代谢）。
  * **输出：** 完整的、可运行的模拟代码文件（例如 `simulation.py`）。

**R2.2 集成参数与控制条件**

  * **需求：** 自动将 R1.4 中生成的参数集成到 R2.1 的代码中，并使用参数和控制条件来计算各模块的代谢速率。

**R2.3 自动运行模拟**

  * **需求：** LLM 或其包装程序能够自动执行生成的模拟代码，并在预设时间步长内记录所有关键代谢物的浓度变化。

### 2.3 阶段 III：结果分析与参数调优（LLM 调优器）

**R3.1 模拟结果与真实数据对比**

  * **需求：** 模拟工具需要能够接收**真实的人体代谢流数据**（或参考值，例如正常血糖波动范围、白蛋白合成速率）。
  * **校验机制：** LLM 需自动分析模拟输出（代谢物流和浓度随时间的变化）与输入真实数据的偏差。

**R3.2 自动调整代码和参数**

  * **需求：** 基于 R3.1 的偏差分析，LLM 必须能够自动诊断代码的问题，并执行以下操作：
      * **参数微调：** 根据偏差程度，对 R1.4 中生成的某些参数值（如 $V_{max}$、激素敏感性）进行迭代式微调。
      * **代码调整（高阶需求）：** 在必要时，LLM 需自动修改 R2.1 中的代码逻辑，以更好地匹配真实代谢流。

**R3.3 迭代与收敛**

  * **需求：** 自动重复 R2.3 到 R3.2 的循环，直到模拟结果与真实代谢流的偏差收敛到预设阈值以下。

## 3\. 技术要求 (Technical Requirements)

### 3.1 LLM 接口

  * **要求：** 必须使用具备强大逻辑推理、代码生成和知识检索能力的 LLM（如 Gemini 等）。
  * **接口：** 需提供稳定的 $\text{API}$ 接口用于自动化调用。

### 3.2 语言与环境

  * **代码生成语言：** Python
  * **数据格式：** JSON/YAML 用于结构化数据交换。

## 4\. 验收标准 (Acceptance Criteria)

| 编号 | 描述 | 验收标准 |
| :--- | :--- | :--- |
| $\text{AC} 1$ | 知识结构化准确性 | LLM 生成的 JSON 文件能够覆盖所有指定模块，且代谢物名称统一、粒度层次清晰。 |
| $\text{AC} 2$ | 模拟代码可运行性 | LLM 生成的 Python 代码能够成功运行，并输出代谢物流时间序列数据，无运行时错误。 |
| $\text{AC} 3$ | 参数自动调优效果 | 经过 $\text{N}$ 次自动迭代调优后，模拟关键代谢物（如血糖、$\text{ATP}$）的波动曲线与真实参考值的平均偏差低于阈值（如 $5\%$）。 |
